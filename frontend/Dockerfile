# === Stage 1: Build ===
FROM node:20-alpine AS build
WORKDIR /app

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY package*.json ./
RUN npm ci || npm install

# –ö–æ–ø–∏—Ä—É–µ–º –≤–µ—Å—å –ø—Ä–æ–µ–∫—Ç
COPY . .

# –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ docker-compose
ARG VITE_API_URL
ARG VITE_WHATSAPP_PHONE
ARG VITE_SECRET_CODE

# –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∏—Ö –≤ ENV, —á—Ç–æ–±—ã Vite —Å–º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_WHATSAPP_PHONE=${VITE_WHATSAPP_PHONE}
ENV VITE_SECRET_CODE=${VITE_SECRET_CODE}

# üß† –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–≤–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
RUN echo "‚öôÔ∏è Building with VITE_API_URL=$VITE_API_URL" && npm run build

# === Stage 2: Nginx runtime ===
FROM nginx:1.27-alpine

# –ö–æ–ø–∏—Ä—É–µ–º nginx –∫–æ–Ω—Ñ–∏–≥
COPY nginx.conf /etc/nginx/conf.d/default.conf

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–π –±–∏–ª–¥
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80
HEALTHCHECK CMD wget -qO- http://127.0.0.1/ || exit 1
